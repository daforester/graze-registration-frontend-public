import{_ as oe,T as Z,u as ue}from"./EmailEditor.vue_vue_type_script_setup_true_lang-DTatkPKs.js";import{u as ie}from"./useConventionSlug-CkFQ5rCe.js";import{i as ee,N as S,D,n as f,M as ne,r as n,C as re,w as de,A as g,h as a,H as j,l as w,q as t,G as N,v as m,Q as me,F as ve,O as fe,x as pe,U as Te,k as Ue}from"./index-DWoJBaAj.js";import{_ as Ve}from"./ModelDialog.vue_vue_type_script_setup_true_lang-CxMvc_Zx.js";import{_ as Ee}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{b as h}from"./forwardRefs-DoDzwsLS.js";import{V as x,a as d}from"./VRow-t6XUObGt.js";import{V as q}from"./VSelect-CyajT2HP.js";import{V as U,o as Ce}from"./VGrid-BjgFpAZn.js";import{V as ge,a as ce}from"./VAlert-DnYhM54q.js";import{V as Ie}from"./VOverlay-CpOp3qgP.js";import{e as De,V as be,a as we,c as Ne}from"./VCard-Bh0GtTSC.js";import{V as Se}from"./VList-BQEmKFTx.js";import{V as ye}from"./VSpacer-qSTNPCcP.js";import{V as B}from"./VTextField-DEVkKC1W.js";import{V as _e}from"./SaveButton.vue_vue_type_script_setup_true_lang-CH1oplkq.js";var Re=(u=>(u.CHECK_IN_STATUS_PENDING="CHECK_IN_STATUS_PENDING",u.CHECK_IN_STATUS_COMPLETED="CHECK_IN_STATUS_COMPLETED",u.CHECK_IN_STATUS_REJECTED="CHECK_IN_STATUS_REJECTED",u.CHECK_IN_STATUS_REVOKED="CHECK_IN_STATUS_REVOKED",u))(Re||{});const Me=[{title:"Pending",value:"CHECK_IN_STATUS_PENDING"},{title:"Completed",value:"CHECK_IN_STATUS_COMPLETED"},{title:"Rejected",value:"CHECK_IN_STATUS_REJECTED"},{title:"Revoked",value:"CHECK_IN_STATUS_REVOKED"}],Ze=u=>{var p;return((p=Me.find(b=>b.value===u))==null?void 0:p.title)||""},ke=["innerHTML"],Pe=ee({__name:"EmailPreviewWindow",props:{modelValue:{required:!0},modelModifiers:{}},emits:["update:modelValue"],setup(u){const p=S(u,"modelValue");return(b,$)=>(f(),D("div",{innerHTML:p.value,class:"reset-styles"},null,8,ke))}}),Ae=Ee(Pe,[["__scopeId","data-v-a08129c7"]]),He={class:"d-flex align-center justify-center",style:{width:"calc(100vw - 25px)",height:"100vh"}},he=ee({__name:"EmailControl",props:ne({modelType:{default:"user"},custom:{type:Boolean,default:!1}},{modelValue:{default:[]},modelModifiers:{},details:{required:!1},detailsModifiers:{},convention:{required:!1,default:void 0},conventionModifiers:{},organisation:{required:!1,default:void 0},organisationModifiers:{}}),emits:["update:modelValue","update:details","update:convention","update:organisation"],async setup(u){let p,b;const $=fe(),{getEmailTemplateList:le}=ue(),{getConvention:ae}=ie(),G=n([]),c=n(["internal","telegram"]),s=n(),y=S(u,"modelValue"),F=S(u,"details"),V=S(u,"convention");V.value||(V.value=([p,b]=re(()=>ae()),p=await p,b(),p));const L=S(u,"organisation"),E=n(0),C=n([]),K=n(!1),_=n(!1),O=n(0),R=n(0),i=n([]),I=n(!1),M=n(""),k=n(""),P=n(""),A=n(""),H=n(!1),J=()=>{var o,e;le(Z.TARGET_TYPE_CONVENTION,((o=L.value)==null?void 0:o.OrganisationUUID)||null,((e=V.value)==null?void 0:e.ConventionUUID)||null).then(l=>{G.value=l})};de(V,()=>{J()}),J();const Y=(o,e=!1)=>{var r;const l={};return u.modelType=="registration"?l.RegistrationUUID=o:u.modelType=="submission"?l.SubmissionUUID=o:l.UserUUID=o,V.value&&(l.ConventionUUID=V.value.ConventionUUID),L.value&&(l.OrganisationUUID=L.value.OrganisationUUID),c.value.length>0&&(l.Methods=c.value),s.value&&(s.value.IsDefault?l.TemplateName=s.value.Name:((r=s.value)==null?void 0:r.EmailTemplateUUID)!==Te?l.TemplateUUID=s.value.EmailTemplateUUID:l.Template=s.value),e&&(l.Template=Ue(s.value),l.TemplateUUID=void 0,l.TemplateName=void 0,l.Template&&(l.Template.HTML=P.value,l.Template.Subject=A.value,l.Template.From=M.value,l.Template.FromName=k.value)),l},z=()=>{C.value=[],y.value.forEach(o=>{const e=Y(o,I.value);$.previewEmailTemplate(e).then(l=>{C.value.push(l)})}),E.value=0,K.value=!0};function te(o){return new Promise(e=>setTimeout(e,o))}const W=async()=>{var o,e;_.value=!0,O.value=0,R.value=0,i.value=[];for(const l of y.value){const r=Y(l,I.value);try{const v=await $.sendEmailTemplate(r);v.Errors.length>0&&v.Errors.forEach(T=>{i.value.push(T)})}catch(v){if(r.RegistrationUUID&&F.value&&F.value.length>0){const T=F.value.find(Q=>{var X;return Q.RegistrationUUID==r.RegistrationUUID||((X=Q.registration)==null?void 0:X.RegistrationUUID)==r.RegistrationUUID});T?T.Reference?i.value.push(`Failed to send to: #${T.Reference} - ${T.Name}`):T.registration?i.value.push(`Failed to send to: #${T.registration.Reference||r.RegistrationUUID} - ${(e=(o=T.registration)==null?void 0:o.User)==null?void 0:e.DisplayName}`):i.value.push(`Failed to send to: UUID ${r.RegistrationUUID}`):i.value.push(`Failed to send to: UUID ${r.RegistrationUUID}`)}else i.value.push(`Failed to send to: UUID ${r.RegistrationUUID}`);v.ResponseCode==401||v.ResponseCode==403?i.value.push("Access Denied"):v.ResponseCode==400?i.value.push(`Bad request: ${v.ErrorMessage}`):v.ResponseCode==404?i.value.push(`Missing data: ${v.ErrorMessage}`):v.ResponseCode==500&&i.value.push(`Internal error: ${v.ErrorMessage}`)}await te(50),O.value+=1,R.value=O.value/y.value.length*100}_.value=!1,i.value.length===0&&(H.value=!0)},se=async()=>{var o,e,l,r;P.value=((o=s.value)==null?void 0:o.HTML)||"",M.value=((e=s.value)==null?void 0:e.From)||"",k.value=((l=s.value)==null?void 0:l.FromName)||"",A.value=((r=s.value)==null?void 0:r.Subject)||"",I.value=!0};return(o,e)=>(f(),D("div",null,[y.value.length>0?(f(),D(j,{key:0},[a(x,null,{default:t(()=>[a(d,null,{default:t(()=>e[17]||(e[17]=[N("h2",null,"E-Mail",-1),N("p",null," Select an e-mail template to send bulk e-mails to selected registrations. You may preview what is sent before queuing it. ",-1)])),_:1})]),_:1}),I.value?g("",!0):(f(),w(x,{key:0},{default:t(()=>[a(d,{cols:"12",md:"6"},{default:t(()=>[a(q,{modelValue:s.value,"onUpdate:modelValue":e[0]||(e[0]=l=>s.value=l),items:G.value,"item-value":l=>l,"item-title":"Title","hide-details":"",clearable:"",label:"Template"},null,8,["modelValue","items","item-value"])]),_:1}),a(d,{cols:"12",md:"6"},{default:t(()=>[a(q,{modelValue:c.value,"onUpdate:modelValue":e[1]||(e[1]=l=>c.value=l),label:"Contact Methods",items:[{title:"Email",value:"internal"},{title:"Telegram",value:"telegram"}],"item-title":"title","item-value":"value",chips:"",multiple:""},null,8,["modelValue"])]),_:1}),o.custom?(f(),w(d,{key:0,cols:"4"},{default:t(()=>[a(U,{color:"warning",disabled:!s.value,onClick:se,class:"w-100"},{default:t(()=>e[18]||(e[18]=[m(" Customise ")])),_:1},8,["disabled"])]),_:1})):g("",!0),a(d,{cols:"4"},{default:t(()=>[a(U,{color:"primary",disabled:!s.value,onClick:z,class:"w-100"},{default:t(()=>e[19]||(e[19]=[m(" Preview ")])),_:1},8,["disabled"])]),_:1}),a(d,{cols:"4",class:"text-right text-sm-left"},{default:t(()=>[a(U,{color:"success",disabled:!s.value,onClick:W,class:"w-100"},{default:t(()=>e[20]||(e[20]=[m(" Send ")])),_:1},8,["disabled"])]),_:1})]),_:1})),i.value.length?(f(),w(ge,{key:1,"border-color":"error",border:"start",class:"mt-4"},{default:t(()=>[a(ce,null,{default:t(()=>e[21]||(e[21]=[m("Errors Encountered")])),_:1}),(f(!0),D(j,null,me(i.value,l=>(f(),D("p",{key:l,class:"my-2"},pe(l),1))),128))]),_:1})):g("",!0),a(Ie,{modelValue:_.value,"onUpdate:modelValue":e[3]||(e[3]=l=>_.value=l),"scroll-strategy":"block","location-strategy":"static","close-on-content-click":!1},{default:t(()=>[N("div",He,[e[24]||(e[24]=m(" > ")),a(De,{class:"ma-0",bordered:""},{default:t(()=>[a(be,null,{default:t(()=>[a(we,{class:"text-center"},{default:t(()=>e[22]||(e[22]=[N("small",null,"Sending Emails",-1)])),_:1})]),_:1}),a(Ne,{class:"text-center"},{default:t(()=>[a(Ce,{modelValue:R.value,"onUpdate:modelValue":e[2]||(e[2]=l=>R.value=l),color:"error",size:"60",width:"8"},null,8,["modelValue"]),e[23]||(e[23]=N("p",{class:"my-4"}," Navigating away will prevent emails from sending. ",-1)),i.value.length?(f(),w(Se,{key:0,items:i.value},null,8,["items"])):g("",!0)]),_:1})]),_:1})])]),_:1},8,["modelValue"]),a(Ve,{modelValue:K.value,"onUpdate:modelValue":e[7]||(e[7]=l=>K.value=l),fullscreen:!1,"hide-details":!0,title:"Email Preview",scrollable:!0},{actions:t(()=>[a(h,null,{default:t(()=>[a(U,{color:"primary",disabled:E.value==0,onClick:e[4]||(e[4]=l=>E.value-=1)},{default:t(()=>e[25]||(e[25]=[m(" Previous ")])),_:1},8,["disabled"])]),_:1}),a(ye),a(h,null,{default:t(()=>[a(U,{color:"primary",disabled:E.value==C.value.length-1,onClick:e[5]||(e[5]=l=>E.value+=1)},{default:t(()=>e[26]||(e[26]=[m(" Next ")])),_:1},8,["disabled"])]),_:1})]),default:t(()=>[C.value.length>0&&C.value[E.value]?(f(),w(Ae,{key:0,modelValue:C.value[E.value].HTML,"onUpdate:modelValue":e[6]||(e[6]=l=>C.value[E.value].HTML=l)},null,8,["modelValue"])):g("",!0)]),_:1},8,["modelValue"])],64)):g("",!0),I.value?(f(),D(j,{key:1},[a(x,null,{default:t(()=>[a(d,{cols:"12",lg:"4"},{default:t(()=>[a(B,{modelValue:A.value,"onUpdate:modelValue":e[8]||(e[8]=l=>A.value=l),label:"Custom Subject",variant:"outlined","hide-details":""},null,8,["modelValue"])]),_:1}),a(d,{cols:"12",md:"6",lg:"4"},{default:t(()=>[a(B,{modelValue:k.value,"onUpdate:modelValue":e[9]||(e[9]=l=>k.value=l),label:"Custom From Name",variant:"outlined","hide-details":""},null,8,["modelValue"])]),_:1}),a(d,{cols:"12",md:"6",lg:"4"},{default:t(()=>[a(B,{modelValue:M.value,"onUpdate:modelValue":e[10]||(e[10]=l=>M.value=l),label:"Custom From Email",variant:"outlined","hide-details":""},null,8,["modelValue"])]),_:1})]),_:1}),a(oe,{modelValue:P.value,"onUpdate:modelValue":e[11]||(e[11]=l=>P.value=l),convention:V.value,"onUpdate:convention":e[12]||(e[12]=l=>V.value=l),"owner-type":ve(Z).TARGET_TYPE_CONVENTION},null,8,["modelValue","convention","owner-type"]),a(x,{class:"justify-end"},{default:t(()=>[a(d,{cols:"12",sm:"6"},{default:t(()=>[a(q,{modelValue:c.value,"onUpdate:modelValue":e[13]||(e[13]=l=>c.value=l),label:"Contact Methods",items:[{title:"Email",value:"internal"},{title:"Telegram",value:"telegram"}],"item-title":"title","item-value":"value",chips:"",multiple:""},null,8,["modelValue"])]),_:1}),a(d,{cols:"4",sm:"2"},{default:t(()=>[a(U,{color:"warning",disabled:!s.value,onClick:e[14]||(e[14]=l=>I.value=!1),class:"w-100"},{default:t(()=>e[27]||(e[27]=[m(" Cancel ")])),_:1},8,["disabled"])]),_:1}),a(d,{cols:"4",sm:"2"},{default:t(()=>[a(U,{color:"primary",disabled:!s.value,onClick:z,class:"w-100"},{default:t(()=>e[28]||(e[28]=[m(" Preview ")])),_:1},8,["disabled"])]),_:1}),a(d,{cols:"4",sm:"2",class:"text-right text-sm-left"},{default:t(()=>[a(U,{color:"success",disabled:!s.value,onClick:W,class:"w-100"},{default:t(()=>e[29]||(e[29]=[m(" Send ")])),_:1},8,["disabled"])]),_:1})]),_:1})],64)):g("",!0),a(_e,{modelValue:H.value,"onUpdate:modelValue":e[16]||(e[16]=l=>H.value=l)},{actions:t(()=>[a(U,{variant:"text",onClick:e[15]||(e[15]=l=>H.value=!1)},{default:t(()=>e[30]||(e[30]=[m(" Close ")])),_:1})]),default:t(()=>[e[31]||(e[31]=m(" E-mail Sent "))]),_:1},8,["modelValue"])]))}});export{Me as C,he as _,Ze as a,Re as b};
