import{u as K}from"./useTitleSetter-pZ7tR6B9.js";import{P as Q}from"./permission-CXLcAQMS.js";import{T as i,u as W,a as X,_ as Z}from"./EmailEditor.vue_vue_type_script_setup_true_lang-DTatkPKs.js";import{C as h,G as ee}from"./canDo-ynXUmMYy.js";import{i as le,C as ae,r as f,w as g,c as te,D as w,h as t,l as U,A as E,q as o,k as F,O as oe,U as ie,n as p,F as d,v as O,H as L,x as $}from"./index-DWoJBaAj.js";import{G as ue}from"./userData-BXpzz9OU.js";import{_ as ne}from"./ModelDialog.vue_vue_type_script_setup_true_lang-CxMvc_Zx.js";import{V as se}from"./VSheet-BC3ozFky.js";import{v as me}from"./v4-CtRu48qb.js";import{V as C}from"./VContainer-BFcMrVbM.js";import{V as R,a as v}from"./VRow-t6XUObGt.js";import{V as Y}from"./VSelect-CyajT2HP.js";import{V as re}from"./VList-BQEmKFTx.js";import{V as B}from"./VGrid-BjgFpAZn.js";import{V as c}from"./VTextField-DEVkKC1W.js";import"./useConventionForms-BuKmEUF4.js";import"./useConventionSlug-CkFQ5rCe.js";import"./VCard-Bh0GtTSC.js";import"./createSimpleFunctional-D3jYYgwj.js";import"./forwardRefs-DoDzwsLS.js";import"./VSpacer-qSTNPCcP.js";import"./VDialog-yG2h32Ey.js";import"./VOverlay-CpOp3qgP.js";import"./scopeId-Cl_fsoSS.js";import"./SaveButton.vue_vue_type_script_setup_true_lang-CH1oplkq.js";import"./VToolbar-CHLZske4.js";import"./form-B38mwiHr.js";import"./VCheckboxBtn-hdHe9uQb.js";import"./VChip-BZ6_PRg8.js";const j=A=>A===void 0?!1:h(A,ee.GROUP_TYPE_SYSTEM).EditOrganisation,Le=le({__name:"TemplatesView",props:{loggedIn:{type:Boolean}},async setup(A){let I,y;K("Email Templates");const P=oe(),b=ue(),{getEmailTemplateList:H}=W(),{Conventions:S,Organisations:G}=([I,y]=ae(()=>P.getPermissionAccessList(Q.PERMISSION_TYPE_EDIT_CONVENTION)),I=await I,y(),I),a=f(),s=f(),V=f(!1),m=f(),n=f(i.TARGET_TYPE_SYSTEM),T=f([]),_=[];j(b)&&_.push({title:"System",value:i.TARGET_TYPE_SYSTEM}),G.length>0&&_.push({title:"Organisational",value:i.TARGET_TYPE_ORGANISATION}),S.length>0&&_.push({title:"Convention",value:i.TARGET_TYPE_CONVENTION}),g(n,()=>{n.value==i.TARGET_TYPE_SYSTEM?(s.value=void 0,m.value=void 0):n.value==i.TARGET_TYPE_ORGANISATION&&(s.value=void 0),N()}),g(m,()=>{m.value&&s.value&&m.value.OrganisationUUID!==s.value.OrganisationUUID&&(s.value=void 0),N()}),g(s,()=>{N()});const N=()=>{var u,l;return H(n.value,((u=m.value)==null?void 0:u.OrganisationUUID)||null,((l=s.value)==null?void 0:l.ConventionUUID)||null).then(e=>{T.value=e})};N();const x=()=>{var u;return{ID:0,EmailTemplateUUID:me(),Name:"",Title:"",OwnerUUID:n.value===i.TARGET_TYPE_SYSTEM?ie:n.value===i.TARGET_TYPE_ORGANISATION?m.value.OrganisationUUID:s.value.ConventionUUID,OwnerType:((u=X.find(l=>l.value===n.value))==null?void 0:u.value)||i.TARGET_TYPE_SYSTEM,From:"",FromName:"",Subject:"",HTML:"",AutoText:!0,Text:"",IsDefault:!1}},q=()=>{const u=T.value.findIndex(l=>a.value&&l.EmailTemplateUUID===a.value.EmailTemplateUUID);u===-1?a.value=x():a.value=F(T.value[u])},M=(u=void 0)=>{u===void 0?a.value=x():a.value=F(u),V.value=!0},z=async u=>{if(a.value)try{const l=await P.saveEmailTemplate(a.value);if(l){const e=T.value.findIndex(r=>r.EmailTemplateUUID===l.EmailTemplateUUID);e===-1?T.value.push(l):T.value.splice(e,1,l),await u("Template Saved"),setTimeout(()=>{a.value=void 0,V.value=!1},500)}else await u("Failed to Save")}catch{await u("Failed to Save")}},J=te(()=>n.value===i.TARGET_TYPE_SYSTEM?j(b):n.value===i.TARGET_TYPE_ORGANISATION?!!m.value:n.value===i.TARGET_TYPE_CONVENTION?!!s.value:!1);return(u,l)=>(p(),w("div",null,[t(se,null,{default:o(()=>[t(C,{class:"bg-secondary",fluid:""},{default:o(()=>[t(R,null,{default:o(()=>[t(v,{cols:"12",sm:"5",md:"3",xl:"2",class:"pa-0"},{default:o(()=>[t(Y,{modelValue:n.value,"onUpdate:modelValue":l[0]||(l[0]=e=>n.value=e),label:"Level",items:_,"hide-details":""},null,8,["modelValue"])]),_:1}),n.value===d(i).TARGET_TYPE_ORGANISATION||n.value===d(i).TARGET_TYPE_CONVENTION?(p(),U(v,{key:0,cols:"12",sm:"7",md:"4",lg:"3",xl:"2",class:"pa-0"},{default:o(()=>[t(Y,{modelValue:m.value,"onUpdate:modelValue":l[1]||(l[1]=e=>m.value=e),label:"Organisation",items:d(G).sort((e,r)=>e.Name.localeCompare(r.Name)),"item-title":"Name","item-value":e=>e,clearable:"","hide-details":""},null,8,["modelValue","items","item-value"])]),_:1})):E("",!0),n.value===d(i).TARGET_TYPE_CONVENTION?(p(),U(v,{key:1,cols:"12",md:"5",lg:"6",xl:"4",class:"pa-0"},{default:o(()=>[t(Y,{modelValue:s.value,"onUpdate:modelValue":l[2]||(l[2]=e=>s.value=e),label:"Convention",items:d(S).filter(e=>!m.value||e.OrganisationUUID===m.value.OrganisationUUID).sort((e,r)=>e.Name.localeCompare(r.Name)),"item-title":"Name","item-value":e=>e,clearable:"","hide-details":""},null,8,["modelValue","items","item-value"])]),_:1})):E("",!0)]),_:1})]),_:1}),t(C,{fluid:""},{default:o(()=>[t(re,{items:T.value,"item-value":e=>e,"item-title":"Title"},{subtitle:o(({item:e})=>{var r,k;return[e.OwnerType==d(i).TARGET_TYPE_ORGANISATION?(p(),w(L,{key:0},[O($((r=d(G).find(D=>D.OrganisationUUID===e.OwnerUUID))==null?void 0:r.Name),1)],64)):e.OwnerType==d(i).TARGET_TYPE_CONVENTION?(p(),w(L,{key:1},[O($((k=d(S).find(D=>D.ConventionUUID===e.OwnerUUID))==null?void 0:k.Name),1)],64)):E("",!0)]}),append:o(({item:e})=>[t(B,{color:"primary","prepend-icon":"mdi:mdi-pencil",onClick:r=>M(e)},{default:o(()=>l[10]||(l[10]=[O(" Edit ")])),_:2},1032,["onClick"])]),_:1},8,["items","item-value"]),J.value?(p(),U(R,{key:0,class:"pr-4"},{default:o(()=>[t(v,{class:"text-right"},{default:o(()=>[t(B,{color:"success","prepend-icon":"mdi:mdi-plus",onClick:l[3]||(l[3]=e=>M())},{default:o(()=>l[11]||(l[11]=[O(" Add New Template ")])),_:1})]),_:1})]),_:1})):E("",!0)]),_:1})]),_:1}),a.value?(p(),U(ne,{key:0,modelValue:V.value,"onUpdate:modelValue":l[9]||(l[9]=e=>V.value=e),title:`Edit Template${a.value.Title?` - ${a.value.Title}`:""}`,onSave:z,onReset:q,fullscreen:!0,scrollable:!0,"card-class":"pa-0 pa-sm-6","retain-focus":!1},{default:o(()=>[t(C,{fluid:""},{default:o(()=>[t(R,null,{default:o(()=>[t(v,{cols:"12"},{default:o(()=>[t(c,{label:"Template Title",variant:"outlined",modelValue:a.value.Title,"onUpdate:modelValue":l[4]||(l[4]=e=>a.value.Title=e),"hide-details":""},null,8,["modelValue"])]),_:1}),t(v,{cols:"12"},{default:o(()=>[t(c,{label:"Default Sender Email Address",variant:"outlined",modelValue:a.value.From,"onUpdate:modelValue":l[5]||(l[5]=e=>a.value.From=e),"hide-details":""},null,8,["modelValue"])]),_:1}),t(v,{cols:"12"},{default:o(()=>[t(c,{label:"Default Sender Name",variant:"outlined",modelValue:a.value.FromName,"onUpdate:modelValue":l[6]||(l[6]=e=>a.value.FromName=e),"hide-details":""},null,8,["modelValue"])]),_:1}),t(v,{cols:"12"},{default:o(()=>[t(c,{label:"Default Email Subject",variant:"outlined",modelValue:a.value.Subject,"onUpdate:modelValue":l[7]||(l[7]=e=>a.value.Subject=e),"hide-details":""},null,8,["modelValue"])]),_:1})]),_:1}),t(Z,{convention:s.value,"owner-type":a.value.OwnerType,"owner-uuid":a.value.OwnerUUID,modelValue:a.value.HTML,"onUpdate:modelValue":l[8]||(l[8]=e=>a.value.HTML=e)},null,8,["convention","owner-type","owner-uuid","modelValue"])]),_:1})]),_:1},8,["modelValue","title"])):E("",!0)]))}});export{Le as default};
