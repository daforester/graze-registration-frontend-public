import{b as ie}from"./FormRenderer.vue_vue_type_style_index_0_lang-DfiUxiEF.js";import{i as le,r as s,c as se,R as ue,E as me,O as de,L as ve,D as T,l as d,A as N,H as R,q as t,n as l,h as o,v as i,G as k,Q as $,x as K}from"./index-DWoJBaAj.js";import{T as fe}from"./ticket-DqurB3v3.js";import{G as pe}from"./userData-BXpzz9OU.js";import{p as ge}from"./performLoginCheck-CPuG-No-.js";import{s as ce}from"./sortSubmissions-BLiX_qgz.js";import{c as ye}from"./canEditForm-D5mOV6pS.js";import{l as ke}from"./SaveButton.vue_vue_type_script_setup_true_lang-CH1oplkq.js";import{u as Ue}from"./useConventionSlug-CkFQ5rCe.js";import{V as z}from"./VContainer-BFcMrVbM.js";import{V as A,a as B,b as q,c as L,d as P,e as J}from"./VCard-Bh0GtTSC.js";import{V}from"./VSpacer-qSTNPCcP.js";import{V as _}from"./VGrid-BjgFpAZn.js";import{V as H,a as Q,d as W}from"./VList-BQEmKFTx.js";const Ie={class:"formView"},Ge=le({__name:"FormView",props:{formType:{default:"REGISTRATION"}},emits:["pageTitle"],setup(X,{emit:Z}){const x=Z,ee=ue(),h=ve(),{getConvention:te}=Ue(),v=de(),U=me.getInstance(),f=s(),u=s(),I=s(),g=s(),j=s(),oe=se(()=>{var a;if(u.value!==void 0){const e=u.value;return ye([e],((a=j.value)==null?void 0:a.Submissions)||[],e.Type)}return!1}),S=s(!1),E=pe(),C=s(!0),D=s(""),m=s(),b=s(!0),G=s(ee.params.formUUID),O=(a,e=!1)=>{const n=(r=void 0)=>{if((r==null?void 0:r.ResponseCode)===403&&r.ErrorMessage=="registration is full"){b.value=!1,sessionStorage.removeItem("ajt_attempt"),localStorage.removeItem("ajt_token"),D.value="GROUP_FULL";return}const p=sessionStorage.getItem("ajt_attempt");let c=ke.parseInt(p||"0");c<2?(sessionStorage.setItem("ajt_attempt",(c+1).toString()),setTimeout(()=>{location.reload()},1e3)):(b.value=!1,sessionStorage.removeItem("ajt_attempt"),localStorage.removeItem("ajt_token"),D.value="Invalid Token")};v.validateRegistrationInviteToken(F,e).then(r=>{r?(m.value=r,b.value=!1,sessionStorage.removeItem("ajt_attempt"),localStorage.removeItem("ajt_token")):n()}).catch(r=>{n(r)})},F=new URL(location.href).searchParams.get("token")||"";F!==""?(localStorage.setItem("ajt_token",location.href),O()):(b.value=!1,C.value=!1);const ae=()=>{O(F,!0)},ne=()=>{U.emit("registration.group.join")},re=()=>{h.push("/")},M=a=>a.Type===fe.TICKET_TYPE_TICKET?a.RequiresAccommodation?"mdi:mdi-home":"mdi:mdi-ticket":a.RequiresAccommodation?"mdi:mdi-home-plus":"mdi:mdi-ticket-confirmation";ge(h);const w=a=>new Promise((e,n)=>{v.getConventionRegistrationGroup(a).then(r=>{r?(g.value=r,e(r)):n()}).catch(()=>{n()}),j.value||v.getRegistrationByConvention(a).then(r=>{r.Submissions.forEach((p,c)=>{var y;p.Form||(r.Submissions[c].Form=((y=u.value)==null?void 0:y.FormUUID)===p.FormUUID?p.Form:void 0)}),ce(r.Submissions),j.value=r})}),Y=async()=>{var n,r,p,c;const a=await te(!0);if(!a)return;f.value=a;const e=await v.getUserConventionSubmissions((E==null?void 0:E.UserUUID)||"",a.ConventionUUID||"");if(e&&(I.value=e.find(y=>y.FormUUID===G.value),I.value)){I.value=await v.getSubmission(I.value.SubmissionUUID),j.value=await v.getRegistrationByConvention(a.ConventionUUID),await w(a.ConventionUUID),u.value=(n=I.value)==null?void 0:n.Form,S.value=!0,x("pageTitle",`Convention Registration - ${((r=f.value)==null?void 0:r.Name)||"New Convention"}`);return}if(u.value=(p=f.value.Forms)==null?void 0:p.find(y=>G.value===void 0&&y.Type===X.formType.toUpperCase()||y.FormUUID===G.value),u.value){await w(a.ConventionUUID),S.value=!0,x("pageTitle",`Convention Registration - ${((c=f.value)==null?void 0:c.Name)||"New Convention"}`);return}F||await h.push("/")};return Y(),x("pageTitle","Convention Registration"),U.on("registration.group.leave",()=>{var a;v.leaveRegistrationGroup(((a=g.value)==null?void 0:a.Registration.RegistrationUUID)||"").then(e=>{var n;e&&w(((n=g.value)==null?void 0:n.Registration.ConventionUUID)||"").then(r=>{U.emit("registration.group.left",r)})})}),U.on("registration.group.join",()=>{var a;w(((a=f.value)==null?void 0:a.ConventionUUID)||"").then(()=>{Y().then(()=>{C.value=!1,(!S.value||!u.value||!f.value||!g.value)&&h.push("/")})})}),U.on("registration.group.remove.member",a=>{v.leaveRegistrationGroup(a).then(e=>{var n;e&&w(((n=g.value)==null?void 0:n.Registration.ConventionUUID)||"").then(r=>{U.emit("registration.group.left",r)})})}),(a,e)=>(l(),T("div",Ie,[b.value?(l(),T(R,{key:0},[],64)):D.value?(l(),d(z,{key:1},{default:t(()=>[o(J,null,{default:t(()=>[o(A,null,{default:t(()=>[o(B,null,{default:t(()=>e[2]||(e[2]=[i(" Failed to join group ")])),_:1}),o(q,{class:"text-wrap"},{default:t(()=>e[3]||(e[3]=[i(" You have not been able to join the group. ")])),_:1})]),_:1}),D.value==="GROUP_FULL"?(l(),d(L,{key:0},{default:t(()=>e[4]||(e[4]=[i(" The group you're attempting to join currently has the maximum number of occupants. The group leader must remove a member before you're able to join. ")])),_:1})):(l(),d(L,{key:1},{default:t(()=>e[5]||(e[5]=[i(" The link may have expired or already been used, request a new link from your group's leader. ")])),_:1})),o(P,null,{default:t(()=>[o(V),o(_,{color:"error",variant:"elevated",onClick:re},{default:t(()=>e[6]||(e[6]=[i("Okay")])),_:1}),o(V)]),_:1})]),_:1})]),_:1})):C.value&&m.value?(l(),d(z,{key:2},{default:t(()=>[m.value.Match?(l(),d(J,{key:0},{default:t(()=>[o(A,null,{default:t(()=>[o(B,null,{default:t(()=>e[7]||(e[7]=[i(" Joined Group ")])),_:1}),o(q,{class:"text-wrap"},{default:t(()=>e[8]||(e[8]=[i(" You have successfully linked your registration. The leader of your group will be responsible for deciding on your accommodation and days you're attending. If you are not happy with this you can leave the group and ask them to join you. Alternatively, if you're unable to agree on options you will need to find a different partner. ")])),_:1})]),_:1}),o(L,null,{default:t(()=>e[9]||(e[9]=[i(" Your accommodation and ticket options that require accommodation will now be controlled by your group leader. ")])),_:1}),o(P,null,{default:t(()=>[o(V),o(_,{color:"error",variant:"elevated",onClick:ne},{default:t(()=>e[10]||(e[10]=[i("Okay")])),_:1}),o(V)]),_:1})]),_:1})):(l(),d(J,{key:1},{default:t(()=>[o(A,null,{default:t(()=>[o(B,null,{default:t(()=>e[11]||(e[11]=[i(" Join Group - Warning ")])),_:1}),o(q,{class:"text-wrap"},{default:t(()=>e[12]||(e[12]=[i(" The leader of the sharing group you're joining has selected different ticket options for the accommodation. ")])),_:1})]),_:1}),o(L,null,{default:t(()=>[m.value&&m.value.MemberTickets.length?(l(),T(R,{key:0},[e[13]||(e[13]=k("strong",null,"These ticket options will be removed",-1)),e[14]||(e[14]=k("br",null,null,-1)),o(H,null,{default:t(()=>[(l(!0),T(R,null,$(m.value.MemberTickets,n=>(l(),d(Q,{key:n.TicketUUID,"prepend-icon":M(n)},{default:t(()=>[o(W,null,{default:t(()=>[i(K(n.Name),1)]),_:2},1024)]),_:2},1032,["prepend-icon"]))),128))]),_:1})],64)):N("",!0),m.value&&m.value.LeaderTickets.length?(l(),T(R,{key:1},[e[15]||(e[15]=k("strong",null,"These ticket options will be added",-1)),o(H,null,{default:t(()=>[(l(!0),T(R,null,$(m.value.LeaderTickets,n=>(l(),d(Q,{key:n.TicketUUID,"prepend-icon":M(n)},{default:t(()=>[o(W,null,{default:t(()=>[i(K(n.Name),1)]),_:2},1024)]),_:2},1032,["prepend-icon"]))),128))]),_:1})],64)):N("",!0),e[16]||(e[16]=k("p",null,[i(" If you do not wish to attend for the same days please "),k("span",{class:"text-red-darken-1 font-weight-bold"},"reject"),i(" this join request. ")],-1)),e[17]||(e[17]=k("p",null,[i(" If you wish to adjust your choices to match the group leader's please "),k("span",{class:"text-green font-weight-bold"},"accept"),i(" this join request. ")],-1))]),_:1}),o(P,null,{default:t(()=>[o(_,{color:"error",variant:"elevated",onClick:e[0]||(e[0]=n=>C.value=!1)},{default:t(()=>e[18]||(e[18]=[i("Reject")])),_:1}),o(V),o(_,{color:"success",variant:"elevated",onClick:ae},{default:t(()=>e[19]||(e[19]=[i("Accept")])),_:1})]),_:1})]),_:1}))]),_:1})):(!C.value||!m.value)&&S.value&&u.value&&f.value&&g.value?(l(),d(ie,{key:3,modelValue:u.value,"onUpdate:modelValue":e[1]||(e[1]=n=>u.value=n),convention:f.value,data:I.value,editable:oe.value,"registration-group":g.value},null,8,["modelValue","convention","data","editable","registration-group"])):N("",!0)]))}});export{Ge as _};
